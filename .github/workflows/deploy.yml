# .github/workflows/deploy.yml
name: Build and Deploy to Server

on:
  release:
    types: [published]

env:
  IMAGE_NAME: ghcr.io/valmy/vibex-backend # Change as needed
  WORKING_DIR: ./backend # Change as needed

jobs:
  #----------------------------------------------
  # JOB 1: Build and Push Podman image to GHCR
  #----------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags) for image
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{date 'YYYYMMDD'}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      # --- THIS STEP IS MODIFIED ---
      - name: Build Podman image
        id: build-image # <-- We add an ID here
        uses: redhat-actions/buildah-build@v2
        with:
          image: ${{ env.IMAGE_NAME }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          containerfiles: |
            ${{ env.WORKING_DIR }}/Dockerfile
          context: ${{ env.WORKING_DIR }}
          # 'push: true' has been REMOVED from this step

      # --- THIS STEP IS NEW ---
      - name: Push to GitHub Container Registry
        uses: redhat-actions/push-to-registry@v2
        with:
          # Use the image name and tags from the 'build-image' step's output
          image: ${{ steps.build-image.outputs.image }}
          tags: ${{ steps.build-image.outputs.tags }}

  #----------------------------------------------
  # JOB 2: Trigger the update on the server
  #----------------------------------------------
  deploy-to-server:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add SSH host key to known_hosts
        run: |
          ssh-keyscan ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: SSH and run deploy commands
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            echo 'Connected to server' &&
            cd ${{ secrets.TARGET_DIR }} &&
            echo 'Changed to directory: ${{ secrets.TARGET_DIR }}' &&
            echo 'Pulling new image with podman-compose...' &&
            podman-compose pull &&
            echo 'Restarting systemd service...' &&
            systemctl --user restart vibex-backend.service &&
            echo 'Deployment complete!'
          "
